=== Mapping OpenCRG data to geographical positions

The C-API does not provide functions for handling geographical coordinates. Instead, the C-API ignores any data associated with map projections.

The MATLAB tools provide a large collection of functions for visualizing, converting and transforming geographic data. <<image-geo_transformations>> shows the available coordinate systems and transformations. Many of these functions are generic and may also be used for data not in OpenCRG format.

[[image-geo_transformations]]
image::geo_transformations.png[transformations, 900, title = "Overview of coordinate transformations."]

Map projection data can be defined either in the OpenCRG file or by accessing the relevant fields of the loaded OpenCRG data.

==== Prerequisites

* You have loaded an OpenCRG data set.
* The OpenCRG data contains the required map projection data.

==== Corresponding C functions

The C-API does not provide functions for visualizing OpenCRG data.

==== Corresponding MATLAB functions

`map_intro[]`::
Display introductory information on handling geographic data.

`[data] = crg_wgs84_crg2html(data, file, opts)`::
Generate a HTML file `file` to display OpenCRG data `data` as a track in a web-based map using OpenLayers. `opts` contains various options for changing the generated HTML file. 

`[file] = map_wgs2html(llh, file, opts)`::
Generate a HTML file `file` to display WGS 84 positions `llh` as a track in a web-based map using OpenLayers. `opts` contains various options for changing the generated HTML file. 

`[enh ell pro] = map_geod2pmap(llh, ell, pro)`::
Convert points `llh` from geodetic coordinates to map coordinates using a forward projection. An ellipsoid struct `ell` and a map projection struct `pro` may be optionally provided.

`[enh ell pro] = map_geod2pmap_tm(llh, ell, pro)`::
Convert points `llh` from geodetic coordinates to map coordinates using forward transverse Mercator projection. An ellipsoid struct `ell` and a map projection struct `pro` may be optionally provided.

`[llh ell pro] = map_pmap2geod_tm(enh, ell, pro)`::
Convert points `enh` from map coordinates to geodetic coordinates `llh` using backward transverse Mercator projection. An ellipsoid struct `ell` and a map projection struct `pro` may be optionally provided.

`[xyz ell] = map_geod2ecef(llh, ell)`::
Convert points `llh` from a geodetic system to ECEF system. An ellipsoid struct `ell` may be optionally provided.

`[xyzb tran] = map_ecef2ecef(xyza, tran, fwbw)`::
Transforms points `xyza` from one ECEF datum to another. A transformation struct `tran` specifying the transformation may be optionally provided. The optional `fwbw` flag specifies, whether to use forward or backward transformation.

`[llh ell] = map_ecef2geod(xyz, ell)`::
Convert points from a ECEF system to a geodetic system. An ellipsoid struct `ell` may be optionally provided.

`[enh dat] = map_global2plocal(llh, dat)`::
Convert points from global geodetic coordinates `llh` to local map coordinates `enh` by transforming from global to local ellipsoid and forward projection on local ellipsoid. `dat` contains information necessary for the conversion. 

`[llh dat] = map_plocal2global(enh, dat)`::
Convert points from local map coordinates `enh` to global geodetic coordinates `llh` by backward projection on a local ellipsoid and datum transformation from a local to global ellipsoid. `dat` contains information necessary for the conversion. 

`[phi ell pro] = map_ptm_north2initiallat(north, ell, pro)`::
Compute the initial latitude values `phi` for given northings `north`. Utility function needed for transverse Mercator projections.

`[marc ell pro] = map_ptm_phi2marc(phi, ell, pro)`::
Compute the meridional arc `marc` for given latitudes `phi`. Utility function needed for transverse Mercator projections.

`[dat] = map_check(dat)`::
Check and update `dat` as used in `map_global2plocal` and `map_plocal2global`.

`[ell] = map_check_elli(ell)`::
Check and update ellipsoid struct `ell`.

`[pro] = map_check_proj(pro)`::
Check and update map projection struct `pro`.

`[tran] = map_check_tran(tran)`::
Check and update datum transformation struct `tran`.

`[url] = crg_wgs84_wgs2url(wgs, opts)`::
Generate a URL `url` for showing WGS 84 coordinates `wgs` using Google Maps. `opts.label` contains a label for the positions.

`[wgs, data] = crg_wgs84_xy2wgs(data, pxy)`::
Transform points `pxy` given in local x/y-coordinates to WGS 84 coordinates `wgs` using the provided OpenCRG data `data` as reference.

`[wgs] = crg_wgs84_wgsxy2wgs(wgs1, wgs2, pxy1, pxy2, pxy, eps, tol, dmin)`::
Transforms points `pxy` given in local x/y-coordinates to WGS 84 coordinates. This transformation uses two reference points. These reference points are passed to the function using both WGS 84 coordinates (`wgs1`, `wgs2`) and local x/y-coordinates (`pxy1`, `pxy2`). `eps`, `tol` and `dmin` define requirements for numerical consistency.

`[dist dbeg dend] = crg_wgs84_dist(wgs1, wgs2)`::
Evaluate the distances `dist` and bearings `dbeg` and `dend` between the WGS 84 positions in `wgs1` and `wgs2`. `dbeg` is the bearing as seen from `wgs1`. `dend` is the bearing as seen from `wgs2`.

`[wgs2 dend] = crg_wgs84_invdist(wgs1, dbeg, dist)`::
Calculate WGS 84 positions `wgs2` defined by a WGS 84 base position `wgs1`, a bearing `dbeg`, and a distance `dist`. `dend` is the bearing as seen from `wgs2`.

`[data] = crg_wgs84_setend(data, dref)`::
Set missing WGS 84 end coordinate with given beginning-to-end direction for the reference line.

==== Examples

===== MATLAB examples

The following example shows the conversion of WGS 84 coordinates to UTM coordinates. As the example position is located Bavaria, Germany, the grid zone is 32U. Both UTM and WGS 84 use the same ellipsoid. Thus, a datum transformation is not required.

----
% example position ASAM e.V. 
% (Altlaufstraße 40, 85635 Höhenkirchen-Siegertsbrunn)
org_llh = [	48.02331, 11.71584, 584.0]; % WGS 84

% create mpro
mpro.gell.nm='WGS84';   % global datum
mpro.proj.nm='UTM_32U'; % map projection including local datum

% WGS 84 llh degree -> WGS 84 llh radian
llh = [pi/180*org_llh(1), pi/180*org_llh(2), org_llh(3)];

% transform WGS 84 llh radian -> UTM_32U
enh_utm = map_geod2pmap_tm(llh, mpro.gell, mpro.proj)

----

The following example shows the conversion WGS 84 coordinates to GK3 coordinates. As the example position is located Bavaria, Germany, the zone number is 4. A datum transformation is required, because GK3 uses the BESSELDHDN ellipsoid, which is different from the WGS 84 ellipsoid.

----
% example position ASAM e.V. 
% (Altlaufstraße 40, 85635 Höhenkirchen-Siegertsbrunn)
org_llh = [	48.02331, 11.71584, 584.0]; % WGS 84

% create mpro
mpro.gell.nm='WGS84';
mpro.lell.nm='BESSELDHDN';
mpro.proj.nm='GK3_4';
mpro.tran.nm='HN7';     % transformation
% 7 Parameter Helmert transformation (example for Bavaria from LDBV)
mpro.tran.ds = -5.2379 * 0.000001;
mpro.tran.rx = (0.7201 / 3600) * (pi / 180);
mpro.tran.ry = (0.1112 / 3600) * (pi / 180);
mpro.tran.rz = (-1.7209 / 3600) * (pi / 180);
mpro.tran.tx = -604.7365;
mpro.tran.ty = -72.3946;
mpro.tran.tz = -424.402;
mpro=map_check(mpro);

% WGS 84 llh degree -> WGS 84 llh radian
llh = [pi/180*org_llh(1), pi/180*org_llh(2), org_llh(3)];

% transform WGS 84 llh radian -> GK3 zone 4 (BESSELDHDN)
% transformation includes datum transformation, see map_global2plocal.m
enh_gk = map_global2plocal(llh, mpro)
----

==== Related topics

* <<Reading an OpenCRG file>>
* <<Evaluating OpenCRG data>>
* <<Map projection data>>